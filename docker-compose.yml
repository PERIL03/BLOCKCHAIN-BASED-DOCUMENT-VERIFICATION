version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: blockchain-doc-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-password123}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-document-verification}
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - blockchain-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Hardhat Local Blockchain Node
  hardhat-node:
    image: node:18-alpine
    container_name: blockchain-doc-hardhat
    restart: unless-stopped
    working_dir: /app
    command: npx hardhat node --hostname 0.0.0.0
    ports:
      - "${HARDHAT_PORT:-8545}:8545"
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/backend/node_modules
      - /app/client/node_modules
    networks:
      - blockchain-network
    environment:
      - NODE_ENV=development
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8545"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API Server
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: blockchain-doc-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5000
      - MONGODB_URI=mongodb://${MONGO_USERNAME:-admin}:${MONGO_PASSWORD:-password123}@mongodb:27017/${MONGO_DATABASE:-document-verification}?authSource=admin
      - BLOCKCHAIN_RPC_URL=http://hardhat-node:8545
      - PRIVATE_KEY=${PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
      - CLIENT_URL=${CLIENT_URL:-http://localhost:3000}
      - BLOCKCHAIN_NETWORK=localhost
    depends_on:
      mongodb:
        condition: service_healthy
      hardhat-node:
        condition: service_healthy
    networks:
      - blockchain-network
    volumes:
      - ./backend:/app
      - /app/node_modules
      - ./deployments:/app/deployments
      - ./artifacts:/app/artifacts
      - ./backend/config:/app/config
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend React Application
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: blockchain-doc-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    environment:
      - REACT_APP_API_URL=http://localhost:${BACKEND_PORT:-5000}
    depends_on:
      - backend
    networks:
      - blockchain-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  blockchain-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
